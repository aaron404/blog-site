<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Automating Dungeons and Diagrams Part 2: Parsing the Game State</title><meta content="Automating Dungeons and Diagrams Part 2: Parsing the Game State" name=title><meta content=Aaron name=author><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" name=description><meta content=website property=og:type><meta content=aaron404.github.io/blog-site/blog/dnd-pt2/ property=og:url><meta content=anemone property=og:site_name><meta content="Automating Dungeons and Diagrams Part 2: Parsing the Game State" property=og:title><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" property=og:description><meta content=aaron404.github.io/blog-site/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=aaron404.github.io/blog-site/blog/dnd-pt2/ property=twitter:url><meta content="Automating Dungeons and Diagrams Part 2: Parsing the Game State" property=twitter:title><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" property=twitter:description><meta content=aaron404.github.io/blog-site/favicon.ico property=twitter:image><link href=aaron404.github.io/blog-site/blog/dnd-pt2/ rel=canonical><link rel="shortcut icon" href=aaron404.github.io/blog-site/favicon.ico type=image/x-icon><link href=aaron404.github.io/blog-site/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=aaron404.github.io/blog-site/css/style.css rel=stylesheet><script defer src=aaron404.github.io/blog-site/js/script.js></script><body><div class=wrapper><header><nav class=navBar><a href=/> /home/ </a><a href=/about> /about/ </a><a href=/journal> /journal/ </a><a href=/blog> /blog/ </a><div class=themeSwitch><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#darkMode></use></svg></button><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#lightMode></use></svg></button></div></nav></header><main><div><a href=..>..</a>/<span class=metaData>dnd-pt2</span></div><time datetime=2024-06-18>Published on: <span class=metaData>2024-06-18</span></time><h1>Automating Dungeons and Diagrams Part 2: Parsing the Game State</h1><h2>Table of contents</h2><ul><li><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#introduction>Introduction</a><li><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#the-game-state>The Game State</a><li><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#let-s-start-coding>Let’s start coding</a></ul><h1 id=introduction><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#introduction>Introduction</a></h1><p>Last time I laid the foundation for game state parsing, namely reading pixels from the screen and normalizing the coordinate system so we don’t have to worry about the rest of the screen outside the DnD window. Today I’d like to go from a screenshot to a representation that I can use in Rust. With that said, my objectives for today are:<ol><li>Detect tile contents (Empty, Treasure, or Monster)<li>Parse the numbers on the top and left side of the board<li>Parse the room seed<li>Read and write the board state to a file<li>(Bonus) Create a catologue of puzzles that I can use for offline testing</ol><h1 id=the-game-state><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#The-game-state>The Game State</a></h1><p>The critical pieces of information we need from the game are the numbers along the top and left edges of the board, and the positions of monsters and treasure chests. For now I will operate under the assumption that the player hasn’t placed any walls or path markers yet (they could have been placed incorrectly and it will throw off the solver), so tiles can only be in one of the following states - <code>Monster</code>, <code>Treasure</code>, or <code>Empty</code>.<p>Reading the state of the board can be done in two ways. The direct approach is to attach a debugger to the process and scan its memory for the relevant data. I have done this before with <a href=https://cheatengine.org/ rel=noopener target=_blank>Cheat Engine</a> and it could probably be done with a simple process memory dump as well. I may return to this idea in the future, but for now I will use the other method of capturing a screenshot of the running game and observing the pixel values in order to deduce the information I need.<p>If you looked closely at the image in the <a href=aaron404.github.io/blog-site/blog/dnd-pt2/#introduction>introduction</a>, you may have noticed that is has a screen distortion effect applied, which would make it difficult to reliably detect colors and positions of image features. It also has 2x pixel scaling, so there is a lot of redundant data in the image. Luckily both of these can be solved by modifying the graphics settings for the game.<div class=textCenter><img alt=asdf src=../../assets/dnd/settings.png></div><p>Here I have changed to windowed mode with the smallest resolution, and disabled pixel stretching and the screen effect.<div class=textCenter><img alt=asdf src=../../assets/dnd/game_small.png></div><p>The result is a game window with 1:1 pixel sizes and no distortion. The downside is that it makes it a tiny window on my monitor, requiring me to sit pretty close to the screen if I am playing it manually. Luckily, if all goes to plan, the game will soon be playing itself!<h1 id=let-s-start-coding><a href=aaron404.github.io/blog-site/blog/dnd-pt2/#lets-start-coding>Let’s start coding</a></h1><p>Very quickly before I get into the code, I’ll highlight a few objectives for this post. I need a program which can do the following:<ol><li>Find a window on the deskop given it’s title, in this case “Last Call BBS”.<li>Capture the framebuffer for that window, and peek into the pixel values.<li>Move the mouse to specific coordinates relative to the window, and perform mouse input (left and right click)<li>(Bonus) Perform keyboard input. This isn’t needed for the solver, but it will help me with some testing and validation later.</ol><p>I originally started implementing this functionality using libX11 directly, but it was neither fun nor straightforward. Instead I’ve decided to delgate window identification and screenshot functionality to the <a href=https://github.com/nashaofu/xcap rel=noopener target=_blank><code>xcap</code></a> crate, and mouse and keyboard input will be performed with <code>enigo</code> (requires <code>libxdo-dev</code> to be installed). Both of these crates claim to have cross-platform support.<p>Let’s start with a simple app to find a window by name, and move the mouse to the center of it. For fun let’s also send a click and then take a screenshot.<pre class=language-rust data-lang=rust style=background:#282c34;color:#abb2bf><code class=language-rust data-lang=rust><span style=color:#c678dd>use </span><span>std::{thread, time::Duration};
</span><span>
</span><span style=color:#c678dd>use </span><span>enigo::{Button, Coordinate, Direction, Enigo, Mouse, Settings};
</span><span style=color:#c678dd>use </span><span>xcap::Window;
</span><span>
</span><span style=color:#c678dd>const </span><span style=color:#d19a66>GAME_TITLE</span><span>: &</span><span style=color:#c678dd>str </span><span>= </span><span style=color:#98c379>"Last Call BBS"</span><span>;
</span><span>
</span><span style=color:#c678dd>fn </span><span style=color:#61afef>main</span><span>() {
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Create an iterator over all the open windows
</span><span>    </span><span style=color:#c678dd>let</span><span> windows = Window::all().</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Search for our specific window 
</span><span>    </span><span style=color:#c678dd>let</span><span> window = windows
</span><span>        .</span><span style=color:#56b6c2>iter</span><span>()
</span><span>        .</span><span style=color:#56b6c2>find</span><span>(|</span><span style=color:#e06c75>win</span><span>| win.</span><span style=color:#56b6c2>title</span><span>() == </span><span style=color:#d19a66>GAME_TITLE</span><span>)
</span><span>        .</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Initialize enigo input simulator
</span><span>    </span><span style=color:#c678dd>let mut</span><span> enigo = Enigo::new(&Settings::default()).</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Move the mouse
</span><span>    enigo
</span><span>        .</span><span style=color:#56b6c2>move_mouse</span><span>(
</span><span>            window.</span><span style=color:#56b6c2>x</span><span>() + window.</span><span style=color:#56b6c2>width</span><span>() as </span><span style=color:#c678dd>i32 </span><span>/ </span><span style=color:#d19a66>2</span><span>,
</span><span>            window.</span><span style=color:#56b6c2>y</span><span>() + window.</span><span style=color:#56b6c2>height</span><span>() as </span><span style=color:#c678dd>i32 </span><span>/ </span><span style=color:#d19a66>2</span><span>,
</span><span>            Coordinate::Abs,
</span><span>        )
</span><span>        .</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Click
</span><span>    enigo.</span><span style=color:#56b6c2>button</span><span>(Button::Left, Direction::Click).</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>
</span><span>    thread::sleep(Duration::from_millis(</span><span style=color:#d19a66>100</span><span>));
</span><span>
</span><span>    </span><span style=font-style:italic;color:#5c6370>// Take a screenshot
</span><span>    </span><span style=color:#c678dd>let</span><span> img = window.</span><span style=color:#56b6c2>capture_image</span><span>().</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>    img.</span><span style=color:#56b6c2>save</span><span>(</span><span style=color:#98c379>"game.png"</span><span>).</span><span style=color:#56b6c2>unwrap</span><span>();
</span><span>}
</span><span>
</span></code></pre><p>This results in the image below - we placed a wall! I had to add <code>thread::sleep</code> in there otherwise the screenshot would happen faster than the game could process the input.<div class=textCenter><img alt=asdf src=../../assets/dnd/clicked.png></div><p>This performs as expected, with a small caveat that it seems to require the mouse to already be above the Last Call BBS window or else the movement and click don’t register. I believe this is likely a bug with Enigo, but for now I’ll live with the limitation as it’s pretty minor.<p class=tagsData></main><footer><hr><div class=footContainer><div class=footLeft><p>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.<br> Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a> colors.<br></div><div class=footRight><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=icons__background href=aaron404.github.io/blog-site/atom.xml target=_blank><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#rss></use></svg></a></div></div></footer></div>