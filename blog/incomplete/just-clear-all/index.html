<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>Just Clear All (Part 1)</title><meta content="Just Clear All (Part 1)" name=title><meta content=Aaron name=author><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" name=description><meta content=website property=og:type><meta content=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/ property=og:url><meta content=anemone property=og:site_name><meta content="Just Clear All (Part 1)" property=og:title><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" property=og:description><meta content=aaron404.github.io/blog-site/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/ property=twitter:url><meta content="Just Clear All (Part 1)" property=twitter:title><meta content="A minimalist Zola theme that prioritizes clean CSS and avoids heavy JavaScript. Enjoy a seamless user experience with lightning-fast load times. Let y…" property=twitter:description><meta content=aaron404.github.io/blog-site/favicon.ico property=twitter:image><link href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/ rel=canonical><link rel="shortcut icon" href=aaron404.github.io/blog-site/favicon.ico type=image/x-icon><link href=aaron404.github.io/blog-site/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=aaron404.github.io/blog-site/css/style.css rel=stylesheet><script defer src=aaron404.github.io/blog-site/js/script.js></script><body><div class=wrapper><header><nav class=navBar><a href=/> /home/ </a><a href=/about> /about/ </a><a href=/journal> /journal/ </a><a href=/blog> /blog/ </a><div class=themeSwitch><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#darkMode></use></svg></button><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#lightMode></use></svg></button></div></nav></header><main><h1>Just Clear All (Part 1)</h1><h2>Table of contents</h2><ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#introduction>Introduction</a><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#reading-the-game-state>Reading the game state</a> <ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#the-old-way>The old way</a> <ul></ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#the-new-way>The new way</a> <ul></ul></ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#solving-the-puzzle>Solving the puzzle</a> <ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#scoring>Scoring</a> <ul></ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#making-a-move>Making a move</a> <ul></ul></ul><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#profiling>Profiling</a><li><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#low-hanging-fruit>Low-hanging Fruit</a></ul><h1 id=introduction><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#introduction>Introduction</a></h1><p>Just Clear All<sup class=footnote-reference><a href=#1>1</a></sup> is a puzzle game release for mobile devices by Veewo in 2015. The rules are quite simple but it lends itself to some emergent complexity that makes it difficult or impossible to complete the game without guessing. Clicking on a number will collapse it and all the contiguous same-number tiles into a new single tile with the value incremented by 1. After the old tiles are deleted, all the blocks settle downwards as if by gravity, and any empty columns are also shuffled to the right. The player gains points through each move and earns large amounts of bonus points based on how many tiles have been removed by the time you have no more valid moves available.<p>I thought it would be fun to solve computationally, and in 2015 I did just that with a crude Python script. It was extremely slow and struggled to run to completion for all but the simplest of puzzle inputs, but it “worked”. I am now revisiting this puzzle with a few more years of experience under my belt, and the performance of a proper systems language (Rust). With this blog post, I intend to come up with a naive solution and find out how much profiling and optimization is needed. Subsequent efforts will follow in future blog posts.<h1 id=reading-the-game-state><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#game-state>Reading the game state</a></h1><p>The first step in solving any puzzle programatically is to find a way represent the game state in your program. Since the game takes the shape of an 8x8 grid of small numbers, I have chosen a 2d array of bytes. In my original Python solution, I initially captured the game state by starting a game on my phone, and manually typing the numbers into an array in the script. I’m sure you’ll believe me when I say this got old very quickly. I figured I could probably just use the Python Imaging Library to look at the pixels RGB values and make a pretty good guess of the digit, but upon closer inspection I noticed there was some subtle variation in the colors which put me off of that method temporarily.<p>You might be asking yourself something like: “Why don’t you just randomly generate numbers for each cell between some lower and upper bound?”. Well, I did try this, but I found the distribution of the numbers didn’t quite “feel” the same as what was presented in the game. It created a large number of small islands rather than what I percieved in the game to be a small number of medium-large islands.<h2 id=the-old-way><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#the-old-way>The old way</a></h2><p>It is a common problem for inexperienced programmers to <a href=https://en.wikipedia.org/wiki/Anchoring_effect rel=noopener target=_blank>anchor</a> to the first solution they think of and assume it is the only way to do something. At the time I was no exception. In a moment of youthful enthusiasm, I came up with a truly bizarre and convoluted solution which I will briefly describe here for comedic effect. My original solution was:<ul><li>Using the Android Debug Bridge (ADB), programatically capture a screenshot of the game<li>Transfer the image to my computer<li>Open the image and crop the individual tiles into sub-images.<li>Send those images to an optical character recognition service hosted on Google cloud (not a joke)<li>Retrieve and parse the json response into a 2d array array of numbers<li>Print the numbers to the terminal so I could manually verify the accuracy of the OCR service</ul><p>Seriously, in hindsight I think I deserve some kind of award for the sheer stubbornness required to make a processes like that work. Eventually I ran out of free Google cloud credits and had to find a different solution. Reconsidering my hasty decision to not use the RGB values, I realized I could truncate the lower bits of each color channel to eliminate the subtle variance I was observing. Taking only the upper 4 bits of each channel of each color, I was able to construct a simple mapping which could be used to quickly parse the board.<pre class=language-python data-lang=python style=background:#282c34;color:#abb2bf><code class=language-python data-lang=python><span>colors = {
</span><span>    (</span><span style=color:#d19a66>12</span><span>, </span><span style=color:#d19a66>14</span><span>, </span><span style=color:#d19a66>6</span><span>): </span><span style=color:#d19a66>1</span><span>, 
</span><span>    (</span><span style=color:#d19a66>11</span><span>, </span><span style=color:#d19a66>14</span><span>, </span><span style=color:#d19a66>5</span><span>): </span><span style=color:#d19a66>1</span><span>, 
</span><span>    (</span><span style=color:#d19a66>6</span><span>, </span><span style=color:#d19a66>11</span><span>, </span><span style=color:#d19a66>14</span><span>): </span><span style=color:#d19a66>2</span><span>, 
</span><span>    (</span><span style=color:#d19a66>5</span><span>, </span><span style=color:#d19a66>11</span><span>, </span><span style=color:#d19a66>15</span><span>): </span><span style=color:#d19a66>2</span><span>, 
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>12</span><span>, </span><span style=color:#d19a66>6</span><span>): </span><span style=color:#d19a66>3</span><span>,
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>12</span><span>, </span><span style=color:#d19a66>5</span><span>): </span><span style=color:#d19a66>3</span><span>, 
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>6</span><span>, </span><span style=color:#d19a66>4</span><span>): </span><span style=color:#d19a66>4</span><span>,
</span><span>    (</span><span style=color:#d19a66>0</span><span>, </span><span style=color:#d19a66>10</span><span>, </span><span style=color:#d19a66>9</span><span>): </span><span style=color:#d19a66>5</span><span>,
</span><span>    (</span><span style=color:#d19a66>2</span><span>, </span><span style=color:#d19a66>10</span><span>, </span><span style=color:#d19a66>9</span><span>): </span><span style=color:#d19a66>5</span><span>,
</span><span>    (</span><span style=color:#d19a66>8</span><span>, </span><span style=color:#d19a66>6</span><span>, </span><span style=color:#d19a66>14</span><span>): </span><span style=color:#d19a66>6</span><span>,
</span><span>    (</span><span style=color:#d19a66>7</span><span>, </span><span style=color:#d19a66>6</span><span>, </span><span style=color:#d19a66>15</span><span>): </span><span style=color:#d19a66>6</span><span>,
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>5</span><span>, </span><span style=color:#d19a66>11</span><span>): </span><span style=color:#d19a66>7</span><span>,
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>5</span><span>, </span><span style=color:#d19a66>12</span><span>): </span><span style=color:#d19a66>7</span><span>,
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>6</span><span>, </span><span style=color:#d19a66>11</span><span>): </span><span style=color:#d19a66>7</span><span>,
</span><span>    (</span><span style=color:#d19a66>14</span><span>, </span><span style=color:#d19a66>2</span><span>, </span><span style=color:#d19a66>4</span><span>): </span><span style=color:#d19a66>8</span><span>,
</span><span>    (</span><span style=color:#d19a66>14</span><span>, </span><span style=color:#d19a66>4</span><span>, </span><span style=color:#d19a66>4</span><span>): </span><span style=color:#d19a66>8</span><span>,
</span><span>    (</span><span style=color:#d19a66>14</span><span>, </span><span style=color:#d19a66>3</span><span>, </span><span style=color:#d19a66>4</span><span>): </span><span style=color:#d19a66>8</span><span>,
</span><span>    (</span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>15</span><span>, </span><span style=color:#d19a66>3</span><span>): </span><span style=color:#d19a66>9</span><span>,
</span><span>    (</span><span style=color:#d19a66>11</span><span>, </span><span style=color:#d19a66>8</span><span>, </span><span style=color:#d19a66>8</span><span>): </span><span style=color:#d19a66>10</span><span>,
</span><span>    (</span><span style=color:#d19a66>11</span><span>, </span><span style=color:#d19a66>8</span><span>, </span><span style=color:#d19a66>7</span><span>): </span><span style=color:#d19a66>10</span><span>,
</span><span>    (</span><span style=color:#d19a66>8</span><span>, </span><span style=color:#d19a66>0</span><span>, </span><span style=color:#d19a66>4</span><span>): </span><span style=color:#d19a66>11
</span><span>}
</span></code></pre><p>This method completely eliminated any parsing errors that I was having from using OCR, and I was considering using the same method for my Rust version, until another thought crossed my mind…<h2 id=the-new-way><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#the-new-way>The new way</a></h2><p>Since the app is no longer available on the Android Play Store, I resorted to pulling the .apk file from an online repository and side-loaded it onto my phone. The game is a bit glitchy (it targets Android version 3!), but generally works and issues can be fixed by restarting the app. I wondered though, if I had access to the .apk, surely I should be able to poke around inside it and find out how the level generation is done. If I could figure that out, I could simply generate puzzles on demand, without even needing to run the app!<p>I searched online for “.apk disassembly tools” and found the bespoke <a href=https://apktool.org/ rel=noopener target=_blank><code>apktool</code></a>. After using this to extract the .apk file, I was pleasantly suprised to find the entire source code of the game in front of my eyes. After an hour or so of wading through the source code, I was able to completely recreate the puzzle generation in Rust, without the need to launch the app or look at any pixels. This is a seriously good starting point, as I can now quickly generate millions of puzzles which I can use to analyze solutions statistically. I won’t show the code as I believe there may be some copyright issues since it is based on the closed source of a commercial project, but I can describe it.<p>The “just generate random numbers!” solution I mentioned above actually wasn’t too far off, and the clever reader may have taken it a step further to suggest “maybe instead of uniform random, we should use weighted random”. This is the key that makes all the difference. In the source code I found the weights and replicated them in my own program. I generate 64 weighted random numbers, and then manually override a random tile with a “heavy” block. Each puzzle has one of these which is higher-valued than all the other tiles.<h1 id=solving-the-puzzle><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#solving-the-puzzle>Solving the puzzle</a></h1><p>Let’s start by quickly setting the stage - what do I mean by “solve” the puzzle? In the context of the game, the only objective is to earn the most points. A fun side goal is to collapse all the numbers into a single remaining tile. Generally speaking, reducing all the tiles to a single one will also generate a high amount of points, but it won’t necessarily be the MOST points. For my solver, I am strictly concerned with getting the most points, disregarding the number of remaining tiles.<h2 id=scoring><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#scoring>Scoring</a></h2><p>The score for a game is the sum of the scores for each move, plus a bonus at the end for the number of tiles cleared. Each move is scored as follows:<pre style=background:#282c34;color:#abb2bf><code><span>multiplier = 1 + floor(number / 5)
</span><span>move_score = island_size * number * 5 * multiplier
</span></code></pre><p>This shows that it is more rewarding to set up large islands rather than collapsing a bunch of small ones. The end-of-round bonus is calculated as follows (where <code>num_tiles</code> represents the number of tiles remaining when there are no more moves left):<pre style=background:#282c34;color:#abb2bf><code><span>bonus = [500, 250, 200, 150, 100, 50][num_tiles - 1] * (level + 1)
</span></code></pre><p>Here we assume the number of remaining tiles is 6 or fewer. If the count of remaining tiles is higher than 6, no bonus is awarded for that level.<h2 id=making-a-move><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#making-a-move>Making a move</a></h2><p>A single move in the game involves selecting any of the non-empty tiles remaining which has an island size of 2 or more. Tapping that tile will initiate a collapse, increment, and add some points to your score. Implementing this in code requires us to do the following steps:<ul><li>Compute the set of tiles within the island we selected (via floodfill)<li>Zero-out all tiles in that island except the one we selected<li>Increment the final tile<li>Collapse the board to remove gaps<li>Update our score</ul><p>After all of that, we will be left with a new game state which we can recursively make moves on, thus performing a depth-first search through the game tree, not unlike a chess engine. After each move, we can check if the score is higher than our current best, and if so output a message to the console. This way we will have realtime feedback on the best-so-far solution and its score. If the program runs to completion, it will have exhaustively searched all possible sequences of moves and the output will be globally optimal. Until then, however, we may be left with only a good-but-not-perfect solution.<h1 id=profiling><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#profiling>Profiling</a></h1><h1 id=low-hanging-fruit><a href=aaron404.github.io/blog-site/blog/incomplete/just-clear-all/#low-hanging-fruit>Low-hanging Fruit</a></h1><p class=tagsData></main><footer><hr><div class=footContainer><div class=footLeft><p>Theme and color theme licensed under <a rel="noopener noreferrer" href=https://en.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a>.<br> Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a> colors.<br></div><div class=footRight><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=icons__background href=aaron404.github.io/blog-site/atom.xml target=_blank><svg class="icons icons__background"><use href=aaron404.github.io/blog-site/icons.svg#rss></use></svg></a></div></div></footer></div>